{% extends "base.html" %}
{% block content %}
<style>
    table tbody tr:hover {
        cursor: pointer;
    }

    .center {
        text-align: center;
        vertical-align: middle;
        /* Aligns text and buttons vertically */
    }

    th,
    td {
        white-space: nowrap;
        text-align: center;
    }
</style>
<ul class="nav nav-pills" role="tablist">
    {% for currency, watchers in currency_groups.items %}
    {% if watchers %}
    <li class="nav-item">
        <a class="nav-link {% if forloop.first %}active{% endif %}" data-toggle="tab" href="#{{ currency }}_tab"
            role="tab">
            {{ currency }}
        </a>
    </li>
    {% endif %}
    {% endfor %}
    <!-- <li class="nav-item ml-auto">
        <button class="btn btn-primary mb-2" type="button" onclick="window.location.href='/create_watcher_form'">
            <i class="fas fa-plus"></i> Add Watcher
        </button>
    </li> -->
</ul>

<div class="tab-content">
    {% for currency, watchers in currency_groups.items %}
    {% if watchers %}
    <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="{{ currency }}_tab" role="tabpanel">
        <div class="table-container data-bg">
            <table class="table table-striped table-bordered table-sm">
                <thead>
                    <tr>
                        <th style="width: 30%; text-align: left;">Name</th>
                        <th style="width: 10%;">Value</th>
                        <th>Invested</th>
                        <th class="mobile-hide">Dist-YTD</th>
                        <th class="mobile-hide">Dist-ITD</th>
                        <th>ROI</th>
                        <th class="mobile-hide">Duration</th>
                        <th class="center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for watcher in watchers %}
                    <tr class="clickable-row" data-watcher-id="{{ watcher.id }}">
                        <td title="Advisor: {{ watcher.advisor }}&#10;Active: {{ watcher.active }}&#10;Type: {{ watcher.type }}&#10;Currency: {{ watcher.currency }}&#10;{{ watcher.count }} Events"
                            style="text-align: left;">
                            {{ watcher.name }}
                            {% if watcher.missing_events %}
                            <span style="color: red;">*</span>
                            {% endif %}
                        </td>
                        <td>{{ watcher.values.value }}</td>
                        <td>{{ watcher.values.invested }}</td>
                        <td class="mobile-hide">{{ watcher.values.Dist_YTD }}</td>
                        <td class="mobile-hide">{{ watcher.values.Dist_ITD }}</td>
                        <td>{{ watcher.values.roi }}</td>
                        <td class="mobile-hide">{{ watcher.values.years }}</td>
                        <td class="center">
                            <button class="btn btn-primary btn-sm" onclick="confirmDelete('{{ watcher.id }}')">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center">No watchers available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>

<!-- Delete Confirmation Dialog -->
<div id="deleteModal" class="modal" tabindex="-1" role="dialog" style="display:none;">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this watcher? All events associated with this watcher will also be
                    deleted.</p>
            </div>
            <div class="modal-footer">
                <form id="deleteForm" method="post" action="">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">YES</button>
                </form>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">NO</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const rows = document.querySelectorAll(".clickable-row");
        rows.forEach(row => {
            row.addEventListener("click", () => {
                const watcherId = row.getAttribute("data-watcher-id");
                window.location.href = "/watcher/" + watcherId;
            });
        });
    });

    function show_events_table(watcherId) {
        event.stopPropagation();
        console.log("show_events_table", watcherId)
        window.location.href = "/events_table/" + watcherId;
    }

    function show_watcher(watcherId) {
        event.stopPropagation();
        console.log("show_watcher", watcherId)
        window.location.href = "/watcher/" + watcherId;
    }


    function confirmDelete(watcherId) {
        event.stopPropagation();

        const deleteModal = document.getElementById('deleteModal');
        const deleteForm = document.getElementById('deleteForm');

        // Set the action URL for the delete form
        deleteForm.action = `/watchers/delete/${watcherId}/`;

        // Show the modal
        deleteModal.style.display = 'block';
    }

    function closeModal() {
        const deleteModal = document.getElementById('deleteModal');
        deleteModal.style.display = 'none';
    }
</script>
{% endblock %}